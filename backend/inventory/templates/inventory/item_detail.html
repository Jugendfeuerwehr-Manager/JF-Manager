{% extends 'home.html' %}
{% load static %}
{% load i18n %}

{% block title %}{{ object.name }} - {{ block.super }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="mt-4">{{ object.name }}</h1>
            <ol class="breadcrumb mb-4">
                <li class="breadcrumb-item"><a href="{% url 'inventory:dashboard' %}">Inventar</a></li>
                <li class="breadcrumb-item"><a href="{% url 'inventory:item_list' %}">Artikel</a></li>
                <li class="breadcrumb-item active">{{ object.name }}</li>
            </ol>
        </div>
    </div>

    <div class="row">
        <!-- Artikel-Details -->
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fa fa-box mr-2"></i>
                        Artikel-Details
                    </h5>
                    <div>
                        {% if can_change_item %}
                        <a href="{% url 'inventory:item_edit' object.pk %}" class="btn btn-warning btn-sm">
                            <i class="fa fa-edit"></i> Bearbeiten
                        </a>
                        {% endif %}
                        {% if can_delete_item %}
                        <a href="{% url 'inventory:item_delete' object.pk %}" class="btn btn-danger btn-sm ml-2">
                            <i class="fa fa-trash"></i> Löschen
                        </a>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Grunddaten</h6>
                            <table class="table table-sm">
                                <tr>
                                    <td><strong>Name:</strong></td>
                                    <td>{{ object.name }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Kategorie:</strong></td>
                                    <td>
                                        {% if object.category %}
                                        <span class="badge badge-secondary">{{ object.category.name }}</span>
                                        {% else %}
                                        <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>Grundeinheit:</strong></td>
                                    <td>{{ object.base_unit }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Gesamtbestand:</strong></td>
                                    <td>
                                        {% if object.total_stock > 0 %}
                                        <span class="badge badge-success">{{ object.total_stock }}</span>
                                        {% else %}
                                        <span class="badge badge-danger">0</span>
                                        {% endif %}
                                    </td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6>Inventarnummern</h6>
                            <table class="table table-sm">
                                <tr>
                                    <td><strong>Hand-Nr.:</strong></td>
                                    <td>{{ object.identifier1|default:"-" }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Barcode-Nr.:</strong></td>
                                    <td>{{ object.identifier2|default:"-" }}</td>
                                </tr>
                            </table>
                            
                            {% if object.attributes %}
                            <h6>Attribute</h6>
                            <table class="table table-sm">
                                {% for key, value in object.attributes.items %}
                                <tr>
                                    <td><strong>{{ key|capfirst }}:</strong></td>
                                    <td>{{ value }}</td>
                                </tr>
                                {% endfor %}
                            </table>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Varianten -->
            {% if object.is_variant_parent %}
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fa fa-th-list mr-2"></i>
                        Artikel-Varianten
                    </h5>
                    <div>
                        <a href="{% url 'inventory:variant_create' %}?parent={{ object.pk }}" class="btn btn-sm btn-success">
                            <i class="fa fa-plus"></i> Variante hinzufügen
                        </a>
                        <a href="{% url 'inventory:bulk_variant_create' parent_pk=object.pk %}" class="btn btn-sm btn-primary ms-2">
                            <i class="fas fa-layer-group"></i> Bulk-Erstellung
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    {% if variants %}
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Eigenschaften</th>
                                        <th>Bestand</th>
                                        <th>Aktionen</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr id="variant-inline-form-row" class="d-none">
                                        <td colspan="4">
                                            <form id="variant-inline-form" class="form-inline">
                                                <div class="form-row align-items-end">
                                                    <div class="col-sm-3 mb-2">
                                                        <label class="small mb-1">SKU</label>
                                                        <input type="text" class="form-control form-control-sm" name="sku" placeholder="Optional">
                                                    </div>
                                                    <div class="col-sm-7 mb-2" id="inline-variant-attributes"></div>
                                                    <div class="col-sm-2 mb-2 text-right">
                                                        <button type="button" class="btn btn-sm btn-primary" id="variant-inline-save">
                                                            <i class="fa fa-save"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-sm btn-secondary" id="variant-inline-cancel">
                                                            <i class="fa fa-times"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </form>
                                        </td>
                                    </tr>
                                    {% for variant in variants %}
                                    <tr>
                                        <td>
                                            <a href="{% url 'inventory:variant_detail' variant.pk %}">{{ variant.name }}</a>
                                        </td>
                                        <td>
                                            {% for key, value in variant.variant_attributes.items %}
                                                <span class="badge badge-secondary mr-1">{{ key }}: {{ value }}</span>
                                            {% empty %}
                                                <span class="text-muted">-</span>
                                            {% endfor %}
                                        </td>
                                        <td>
                                            {% with variant_stock=variant.total_stock %}
                                                {% if variant_stock > 0 %}
                                                    <span class="badge badge-success">{{ variant_stock }} {{ object.base_unit }}</span>
                                                {% elif variant_stock == 0 %}
                                                    <span class="badge badge-warning">Leer</span>
                                                {% else %}
                                                    <span class="badge badge-danger">{{ variant_stock }} {{ object.base_unit }}</span>
                                                {% endif %}
                                            {% endwith %}
                                        </td>
                                        <td>
                                            <a href="{% url 'inventory:variant_detail' variant.pk %}" class="btn btn-sm btn-outline-primary">
                                                <i class="fa fa-eye"></i>
                                            </a>
                                            {% if can_add_transaction %}
                                            <a href="{% url 'inventory:transaction_create' %}?item_variant={{ variant.pk }}" class="btn btn-sm btn-outline-success ml-1" title="Transaktion">
                                                <i class="fa fa-exchange-alt"></i>
                                            </a>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-2">
                            <button class="btn btn-outline-secondary btn-sm" id="variant-inline-add">
                                <i class="fa fa-plus"></i> Inline Variante
                            </button>
                        </div>
                    {% else %}
                        <p class="text-muted mb-0">Noch keine Varianten vorhanden.</p>
                        <div class="mt-2">
                            <button class="btn btn-outline-secondary btn-sm" id="variant-inline-add">
                                <i class="fa fa-plus"></i> Erste Variante anlegen
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>
            {% else %}
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fa fa-th-list mr-2"></i> Varianten</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-2">Für diesen Artikel sind noch keine Varianten aktiviert.</p>
                    {% if can_change_item %}
                    <form method="post" action="{% url 'inventory:variant_create' %}?parent={{ object.pk }}" class="d-inline">
                        {% csrf_token %}
                        <a href="{% url 'inventory:variant_create' %}?parent={{ object.pk }}" class="btn btn-sm btn-outline-secondary">
                            <i class="fa fa-toggle-on"></i> Varianten aktivieren & erste Variante anlegen
                        </a>
                    </form>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Bestände -->
            {% if stocks or variant_stocks %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fa fa-warehouse mr-2"></i>
                        Bestände nach Lagerort
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Lagerort</th>
                                    <th>Bezug</th>
                                    <th>Menge</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for stock in stocks %}
                                    <tr>
                                        <td>{{ stock.location.name }}</td>
                                        <td><span class="badge badge-light">Artikel</span></td>
                                        <td>{{ stock.quantity }}</td>
                                        <td>
                                            {% if stock.quantity > 0 %}
                                                <span class="badge badge-success">Verfügbar</span>
                                            {% else %}
                                                <span class="badge badge-secondary">Leer</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                                {% for vstock in variant_stocks %}
                                    <tr>
                                        <td>{{ vstock.location.name }}</td>
                                        <td>
                                            <a href="{% url 'inventory:variant_detail' vstock.item_variant.pk %}" class="badge badge-info text-decoration-none">Variante</a>
                                        </td>
                                        <td>{{ vstock.quantity }}</td>
                                        <td>
                                            {% if vstock.quantity > 0 %}
                                                <span class="badge badge-success">Verfügbar</span>
                                            {% else %}
                                                <span class="badge badge-secondary">Leer</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Transaktions-Historie -->
            {% if transactions %}
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fa fa-history mr-2"></i>
                        Letzte Transaktionen
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Datum</th>
                                    <th>Typ</th>
                                    <th>Menge</th>
                                    <th>Von</th>
                                    <th>Nach</th>
                                    <th>Benutzer</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for transaction in transactions %}
                                <tr>
                                    <td>{{ transaction.date|date:"d.m.Y H:i" }}</td>
                                    <td>
                                        <span class="badge badge-{% if transaction.transaction_type == 'IN' %}success{% elif transaction.transaction_type == 'OUT' %}warning{% elif transaction.transaction_type == 'LOAN' %}info{% elif transaction.transaction_type == 'RETURN' %}primary{% elif transaction.transaction_type == 'DISCARD' %}danger{% else %}secondary{% endif %}">
                                            {{ transaction.get_transaction_type_display }}
                                        </span>
                                    </td>
                                    <td>{{ transaction.quantity }}</td>
                                    <td>{{ transaction.source.name|default:"-" }}</td>
                                    <td>{{ transaction.target.name|default:"-" }}</td>
                                    <td>{{ transaction.user.get_full_name|default:transaction.user.username|default:"-" }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Seitenleiste -->
        <div class="col-lg-4">
            <!-- Schnellaktionen -->
            {% if perms.inventory.add_transaction %}
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fa fa-bolt mr-2"></i>
                        Schnellaktionen
                    </h6>
                </div>
                <div class="card-body">
                    <a href="{% url 'inventory:transaction_create' %}?item={{ object.pk }}" class="btn btn-primary btn-block mb-2">
                        <i class="fa fa-exchange-alt"></i> Neue Transaktion
                    </a>
                    <a href="{% url 'inventory:transaction_list' %}?item={{ object.pk }}" class="btn btn-outline-secondary btn-block">
                        <i class="fa fa-history"></i> Alle Transaktionen
                    </a>
                </div>
            </div>
            {% endif %}

            <!-- Statistiken -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fa fa-chart-bar mr-2"></i>
                        Statistiken
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Gesamtbestand:</span>
                        <strong>{{ object.total_stock }}</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Lagerorte:</span>
                        <strong>{{ stocks|length }}</strong>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Transaktionen:</span>
                        <strong>{{ transactions|length }}+</strong>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Embed data via hidden elements
</script>
<div id="variant-data"
    data-parent-id="{{ object.pk }}"
    data-category-schema='{{ object.category.schema|default:"{}"|escapejs }}'></div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const addBtn = document.getElementById('variant-inline-add');
    if (!addBtn) return;
    const row = document.getElementById('variant-inline-form-row');
    const form = document.getElementById('variant-inline-form');
    const attrsContainer = document.getElementById('inline-variant-attributes');
    const saveBtn = document.getElementById('variant-inline-save');
    const cancelBtn = document.getElementById('variant-inline-cancel');
    const dataRoot = document.getElementById('variant-data');
    const parentIdValue = parseInt(dataRoot.dataset.parentId, 10);
    let categorySchema = {};
    try { categorySchema = JSON.parse(dataRoot.dataset.categorySchema || '{}'); } catch(e) { categorySchema = {}; }

    function buildAttributeInputs() {
        attrsContainer.innerHTML = '';
        Object.entries(categorySchema || {}).forEach(([name, type]) => {
            const wrap = document.createElement('div');
            wrap.className = 'mb-2 mr-2 d-inline-block';
            const label = document.createElement('label');
            label.className = 'small mb-1 d-block';
            label.textContent = name;
            let input = document.createElement('input');
            if (typeof type === 'object') type = type.type || 'text';
            switch ((type||'').toString().toLowerCase()) {
                case 'number': input.type='number'; break;
                case 'boolean': input.type='checkbox'; break;
                case 'date': input.type='date'; break;
                default: input.type='text';
            }
            input.className = 'form-control form-control-sm';
            input.name = 'attr_'+name;
            wrap.appendChild(label); wrap.appendChild(input);
            attrsContainer.appendChild(wrap);
        });
    }

    addBtn.addEventListener('click', () => {
        row.classList.remove('d-none');
        buildAttributeInputs();
    });
    cancelBtn.addEventListener('click', () => {
        row.classList.add('d-none');
        form.reset();
    });
    saveBtn.addEventListener('click', async () => {
        const formData = new FormData(form);
        const variantAttrs = {};
        for (const [key, val] of formData.entries()) {
            if (key.startsWith('attr_')) {
                const attrName = key.replace('attr_', '');
                const schemaType = categorySchema[attrName];
                if ((schemaType||'').toString().toLowerCase() === 'number') {
                    variantAttrs[attrName] = val ? Number(val) : null;
                } else if ((schemaType||'').toString().toLowerCase() === 'boolean') {
                    variantAttrs[attrName] = (val === 'on');
                } else {
                    variantAttrs[attrName] = val;
                }
            }
        }
    const payload = {parent_item: parentIdValue, sku: formData.get('sku') || '', variant_attributes: variantAttrs};
        try {
            const resp = await fetch('/inventory/api/variants/', {
                method:'POST',
                headers:{'Content-Type':'application/json','X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value},
                body: JSON.stringify(payload)
            });
            if (!resp.ok) {
                console.error('Save variant failed', resp.status);
                return;
            }
            // Refresh variants table by reloading page segment quickly
            window.location.reload();
        } catch(e){console.error(e);}
    });
});
</script>
{% endblock %}
